#{extends 'main.html' /}
#{set title:'Listagem de Produtos' /}

<section class="order_details section-margin--small" style="margin-top: 50px;">
	<div class="container">
		<div class="login_form_inner register_form_inner shadow p-4 rounded bg-white">

			<h2 class="text-center mb-4" style="font-weight: 600;">ðŸ“¦ Produtos DisponÃ­veis</h2>

			<!-- FORM DE PESQUISA -->
			<form class="row login_form mb-4" id="buscarProdutos" action="@{Produtos.listar}">
				<div class="col-md-12 d-flex gap-2">
					<input type="text" 
						name="termo" 
						value="${termo}" 
						class="form-control form-control-lg rounded-pill px-4 shadow-sm" 
						placeholder="Buscar por nome ou categoria" style="font-size: 15px;"/>

					<button class="btn rounded-pill px-4 shadow-sm">
						<i class="fa fa-search"></i> Buscar
					</button>
				</div>
			</form>

			<!-- TABELA -->
			<div class="table-responsive shadow-sm rounded">
				<table class="table table-hover align-middle">
					<thead class="bg-light">
						<tr class="text-center">
							<th>Produto</th>
							<th>Categoria</th>
							<th>PreÃ§o</th>
							<th>Quantidade</th>
							<th><i class="fa-solid fa-pen"></i></th>
							<th><i class="fa-solid fa-trash"></i></th>
						</tr>
					</thead>

					<tbody id="resultado">
						#{list items:produtos, as:'p'}
							<tr class="text-center">
								<td class="fw-semibold">${p.nomeProduto}</td>

								<td>${p.categoria?.categoria}</td>

								<td class="fw-bold text-success">R$ ${p.preco}</td>

								<td>
									<div class="d-flex justify-content-center align-items-center gap-2">
										<button class="btn btn-sm btn-outline-secondary rounded-circle" style='width:28px; height:28px; padding:0;'
											onclick="alterarQtd('${p.id}', -1)">âˆ’</button>

										<span id="qtd-${p.id}" class="fw-bold">${p.quantidade}</span>

										<button class="btn btn-sm btn-outline-secondary rounded-circle" style='width:28px; height:28px; padding:0;'
											onclick="alterarQtd('${p.id}', +1)">+</button>
									</div>
								</td>

								<td>
									<a href="@{Produtos.editar(p.id)}" 
										class="btn btn-sm btn-outline-primary rounded-pill px-3">
										Editar
									</a>
								</td>
								<td>
									<a href="@{Produtos.remover(p.id)}" 
										class="btn btn-sm btn-outline-danger rounded-pill px-3">
										Remover
									</a>
								</td>
							</tr>
						#{/list}

						#{else}
						<tr>
							<td colspan="7" class="text-center py-4">
								<p>Nenhum produto cadastrado.</p>
								<a class="btn btn-primary" href="@{Produtos.form}">Adicionar Produto</a>
							</td>
						</tr>
						#{/else}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</section>

<!-- SCRIPT AJAX -->
<script type="text/javascript">
$(document).ready(function() {

	window.alterarQtd = function(id, valor) {
		$.ajax({
			type: "POST",
			url: "@{Produtos.alterarQuantidade}",
			data: { id: id, valor: valor },
			success: function(novaQtd) {
				$("#qtd-" + id).fadeOut(100, function() {
					$(this).text(novaQtd).fadeIn(100);
				});
			},
			error: function() {
				alert("Erro ao atualizar quantidade!");
			}
		});
	};

	$("#buscarProdutos").submit(function(e) {
		e.preventDefault();

		$.ajax({
			type: "post",
			url: "@{Produtos.listarAjax}",
			data: $("#buscarProdutos").serialize(),

			success: function(data) {

				$("#resultado").empty();

				if (!data || data.length === 0) {
					$("#resultado").append(
						"<tr>" +
							"<td colspan='7' class='text-center py-4'>" +
								"<p>Nenhum produto encontrado.</p>" +
								"<a href='@{Produtos.form}' class='btn btn-primary'>Adicionar Produto</a>" +
							"</td>" +
						"</tr>"
					);
					return;
				}

				$.each(data, function(i, p) {

					var categoria = p.categoria?.categoria || "";

					$("#resultado").append(
						"<tr class='text-center'>" +
							"<td class='fw-semibold'>" + p.nomeProduto + "</td>" +
							"<td>" + categoria + "</td>" +
							"<td class='fw-bold text-success'>R$ " + p.preco + "</td>" +

							"<td>" +
								"<div class='d-flex justify-content-center align-items-center gap-2'>" +
									"<button class='btn btn-sm btn-outline-secondary rounded-circle' style='width:35px;' onclick=\"alterarQtd('" + p.id + "', -1)\">âˆ’</button>" +
									"<span id='qtd-" + p.id + "' class='fw-bold'>" + p.quantidade + "</span>" +
									"<button class='btn btn-sm btn-outline-secondary rounded-circle' style='width:35px;' onclick=\"alterarQtd('" + p.id + "', +1)\">+</button>" +
								"</div>" +
							"</td>" +

							"<td><a href='/produtos/editar?id=" + p.id + "' class='btn btn-sm btn-outline-primary rounded-pill px-3'>Editar</a></td>" +
							"<td><a href='/produtos/remover?id=" + p.id + "' class='btn btn-sm btn-outline-danger rounded-pill px-3'>Remover</a></td>" +
						"</tr>"
					);
				});
			}
		});
	});
});
</script>
